<!DOCTYPE html>
<html lang="pt-BR">
<head>
Â <meta charset="UTF-8">
Â <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finalizar Compra</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./src/pagamento.css">
</head>
<body>
Â  Â  
<div class="container-pagamento">
Â  Â  <a href="./catalogo.html" class="botao-voltar">
Â  Â  Â  Â  <i class="fas fa-arrow-left"></i> Voltar para o CatÃ¡logo
Â  Â  </a>
<header>
<h1>Finalizar Compra</h1>
<div class="car-info-display">
<div id="car-image-container" class="car-image-container">
</div>
<p>VeÃ­culo: <strong id="car-name"></strong></p>
</div>
</header>

<section class="payment-details">
<h2>2. Detalhes do Pagamento</h2>
<form id="payment-form">
<div class="form-group">
<label for="installments">Parcelamento</label>
<select id="installments" name="installments">
</select>
</div>
</form>
Â </section>

Â <hr>

Â <section class="order-summary">
Â <h2>3. Resumo do Pedido</h2>
Â <div class="summary-item" id="item-subtotal">
Â <span>Valor do VeÃ­culo:</span>
Â <span id="subtotal-display">R$ 0,00</span>
Â </div>
Â <div class="summary-item" id="item-shipping">
Â <span>Frete (Entrega):</span>
Â <span id="shipping-display">R$ 0,00</span>
Â </div>
Â <div class="summary-total">
Â <strong>Total a Pagar:</strong>
Â <strong id="total-display">R$ 0,00</strong> 
Â </div>

Â <p style="margin-top: 10px;">Parcela Selecionada: <strong id="parcel-value-display"></strong></p>

Â <button type="submit" class="btn-comprar vermelho" form="payment-form">
Pagar Agora (<span id="payment-button-text">R$ 0,00</span>)
</button>

Â Â <button type="button" id="btn-cadastro" class="btn-cadastro verde">
frete-gratis
Â </button>

</section>
</div>

<script>

Â  Â  
Â  Â  // NOVO: MAPA PARA BUSCAR O CAMINHO DA IMAGEM
Â  Â  const CAR_IMAGE_MAP = {
Â  Â  Â  Â  'Mercedes class c': './imagem car/photo-1704476945065-18a15cdbfce2.jpg',
Â  Â  Â  Â  'Nissan GT-R': './imagem car/desktop-wallpaper-white-car-background.jpg',
Â  Â  Â  Â  'Volkswagen Gol G5': './imagem car/Volkswagen_Red_Metallic_White_background_592789_1280x853.jpg',
Â  Â  Â  Â  'Fiat Pulse': './imagem car/Fiat-Pulse.webp',
Â  Â  Â  Â  'Renault Kwid': './imagem car/Kwid.jpg',
Â  Â  Â  Â  'Volkswagen polo': './imagem car/Volkswagen_Polo_Orange_White_background_528204_1280x815.jpg',
Â  Â  Â  Â  'Hyundai tucson': './imagem car/Hyundai_Tucson_White_background_Light_Blue_515412_1280x720.jpg',
Â  Â  Â  Â  'Ram 2500': './imagem car/Ranger.webp',
Â  Â  Â  Â  // Adicione outros carros conforme necessÃ¡rio
Â  Â  };

Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  Â  Â  const nomeCarro = params.get('nome');
Â  Â  Â  Â  let valorCarro = parseFloat(params.get('valor'));
Â  Â  Â  Â  
Â  Â  Â  Â  // NOVO: Busca o URL da imagem no mapa usando o nome do carro
Â  Â  Â  Â  const imagemCarroUrl = CAR_IMAGE_MAP[nomeCarro] || 'https://i.imgur.com/w9c5A7i.jpeg'; // Fallback

Â  Â  Â  Â  // VariÃ¡veis de controle
Â  Â  Â  Â  let valorFrete = 5000; 
Â  Â  Â  Â  const jurosPorMes = 0.02; 
Â  Â  Â  Â  const opcoesParcelas = [1, 3, 6, 12, 24, 36, 48, 60];
Â  Â  Â  Â  const totalBruto = valorCarro || 0; 
Â  Â  Â  Â  
Â  Â  Â  Â  // Elementos DOM
Â  Â  Â  Â  const nomeCarroElement = document.getElementById('car-name');
Â  Â  Â  Â  const carImageContainer = document.getElementById('car-image-container');
Â  Â  Â  Â  const subtotalDisplay = document.getElementById('subtotal-display');
Â  Â  Â  Â  const shippingDisplay = document.getElementById('shipping-display');
Â  Â  Â  Â  const totalDisplay = document.getElementById('total-display');
Â  Â  Â  Â  const installmentsSelect = document.getElementById('installments');
Â  Â  Â  Â  const parcelValueDisplay = document.getElementById('parcel-value-display');
Â  Â  Â  Â  const paymentButtonText = document.getElementById('payment-button-text');
Â  Â  Â  Â  // Usamos o ID aqui:
Â  Â  Â  Â  const btnCadastro = document.getElementById('btn-cadastro');
Â  Â  Â  Â  const itemShipping = document.getElementById('item-shipping');

Â  Â  Â  Â  // ***********************************************
Â  Â  Â  Â  // NOVO: CHECA O LOCALSTORAGE EM VEZ DO PARÃ‚METRO URL
Â  Â  Â  Â  const freteAplicadoViaStorage = localStorage.getItem('freteGratisAplicado') === 'true';
Â  Â  Â  Â  // ***********************************************
Â  Â  Â  Â  
Â  Â  Â  Â  // O parÃ¢metro 'cadastro_sucesso' nÃ£o Ã© mais o principal, mas podemos usÃ¡-lo se quiser
Â  Â  Â  Â  // para dar feedback imediato, embora o localStorage seja mais robusto.
Â  Â  Â  Â  
Â  Â  Â  Â  if (freteAplicadoViaStorage) {
Â  Â  Â  Â  Â  Â  valorFrete = 0; // Zera o frete
Â  Â  Â  Â  Â  Â  btnCadastro.textContent = 'Frete GrÃ¡tis Aplicado!';
Â  Â  Â  Â  Â  Â  btnCadastro.disabled = true;
Â  Â  Â  Â  Â  Â  btnCadastro.classList.remove('verde');
Â  Â  Â  Â  Â  Â  btnCadastro.classList.add('cinza-desabilitado'); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // ***********************************************
Â  Â  Â  Â  Â  Â  // NOVO: LIMPA O LOCALSTORAGE APÃ“S APLICAÃ‡ÃƒO
Â  Â  Â  Â  Â  Â  // Isso garante que o Frete GrÃ¡tis nÃ£o se aplique a outras compras.
Â  Â  Â  Â  Â  Â  localStorage.removeItem('freteGratisAplicado');
Â  Â  Â  Â  Â  Â  // ***********************************************
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FunÃ§Ã£o para Carregar a Imagem ---
Â  Â  Â  Â  function loadCarImage(url, nome) {
Â  Â  Â  Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  Â  Â  Â  img.src = url;
Â  Â  Â  Â  Â  Â  img.alt = `Foto do veÃ­culo: ${nome}`;
Â  Â  Â  Â  Â  Â  img.classList.add('car-photo');
Â  Â  Â  Â  Â  Â  carImageContainer.appendChild(img);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FunÃ§Ãµes de CÃ¡lculo e FormataÃ§Ã£o ---

Â  Â  Â  Â  function formatarMoeda(valor) {
Â  Â  Â  Â  Â  Â  return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
Â  Â  Â  Â  }

Â  Â  Â  Â  function calcularParcela(valorPrincipal, taxaMensal, numParcelas) {
Â  Â  Â  Â  Â  Â  if (numParcelas === 1) return valorPrincipal;
Â  Â  Â  Â  Â  Â  const i = taxaMensal;
Â  Â  Â  Â  Â  Â  const n = numParcelas;
Â  Â  Â  Â  Â  Â  // FÃ³mula da Tabela Price
Â  Â  Â  Â  Â  Â  const powFactor = Math.pow(1 + i, n);
Â  Â  Â  Â  Â  Â  return valorPrincipal * (i * powFactor) / (powFactor - 1);
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateAllCalculations() {
Â  Â  Â  Â  Â  Â  // O valorFrete aqui jÃ¡ serÃ¡ 0 se o frete foi aplicado
Â  Â  Â  Â  Â  Â  const valorBaseCalculo = totalBruto + valorFrete; 
Â  Â  Â  Â  Â  Â  let optionsHTML = '';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  opcoesParcelas.forEach(parcela => {
Â  Â  Â  Â  Â  Â  Â  Â  let valorParcela;
Â  Â  Â  Â  Â  Â  Â  Â  let textoOpcao;
Â  Â  Â  Â  Â  Â  Â  Â  let valorTotalComJuros = valorBaseCalculo;

Â  Â  Â  Â  Â  Â  Â  Â  if (parcela <= 12) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valorParcela = valorBaseCalculo / parcela;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valorTotalComJuros = valorBaseCalculo; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  textoOpcao = `${parcela}x de ${formatarMoeda(valorParcela)} (Sem Juros)`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valorParcela = calcularParcela(valorBaseCalculo, jurosPorMes, parcela);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valorTotalComJuros = valorParcela * parcela; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  textoOpcao = `${parcela}x de ${formatarMoeda(valorParcela)} (Total: ${formatarMoeda(valorTotalComJuros)})`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  optionsHTML += `<option value="${parcela}" data-parcel-value="${valorParcela.toFixed(2)}" data-total-value="${valorTotalComJuros.toFixed(2)}">${textoOpcao}</option>`;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  installmentsSelect.innerHTML = optionsHTML;
Â  Â  Â  Â  Â  Â  updateSummary(); 
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateSummary() {
Â  Â  Â  Â  Â  Â  const selectedOption = installmentsSelect.options[installmentsSelect.selectedIndex];

Â  Â  Â  Â  Â  Â  if (!selectedOption) {
Â  Â  Â  Â  Â  Â  Â  Â  totalDisplay.textContent = formatarMoeda(totalBruto + valorFrete); 
Â  Â  Â  Â  Â  Â  Â  Â  parcelValueDisplay.textContent = 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  paymentButtonText.textContent = formatarMoeda(0);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const valorParcelaAtual = parseFloat(selectedOption.getAttribute('data-parcel-value'));
Â  Â  Â  Â  Â  Â  const valorTotalComJuros = parseFloat(selectedOption.getAttribute('data-total-value'));
Â  Â  Â  Â  Â  Â  const numParcelas = parseInt(selectedOption.value);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  totalDisplay.textContent = formatarMoeda(valorTotalComJuros); 

Â  Â  Â  Â  Â  Â  if (numParcelas === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  parcelValueDisplay.textContent = `${formatarMoeda(valorParcelaAtual)} Ã  vista`;
Â  Â  Â  Â  Â  Â  Â  Â  paymentButtonText.textContent = formatarMoeda(valorParcelaAtual);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  parcelValueDisplay.textContent = `${numParcelas}x de ${formatarMoeda(valorParcelaAtual)}`;
Â  Â  Â  Â  Â  Â  Â  Â  paymentButtonText.textContent = `1Âª Parcela de ${formatarMoeda(valorParcelaAtual)}`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  shippingDisplay.textContent = formatarMoeda(valorFrete);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Aplica estilos de Frete GrÃ¡tis
Â  Â  Â  Â  Â  Â  if (valorFrete === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  itemShipping.classList.add('frete-gratis-aplicado');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  itemShipping.classList.remove('frete-gratis-aplicado');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- FunÃ§Ã£o de Redirecionamento ---
Â  Â  Â  Â  function redirectToCadastro() {
Â  Â  Â  Â  Â  Â  if (!btnCadastro.disabled) {
Â  Â  Â  Â  Â  Â  Â  Â  // Passa apenas nome e valor do carro
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = `cadastro.html?nome=${encodeURIComponent(nomeCarro || '')}&valor=${valorCarro || 0}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // 1. Preencher informaÃ§Ãµes iniciais e carregar imagem
Â  Â  Â  Â  loadCarImage(imagemCarroUrl, nomeCarro);
Â  Â  Â  Â  
Â  Â  Â  Â  nomeCarroElement.textContent = nomeCarro || 'Carro de Teste'; 
Â  Â  Â  Â  valorCarro = valorCarro || 15000; 
Â  Â  Â  Â  subtotalDisplay.textContent = formatarMoeda(totalBruto);
Â  Â  Â  Â  
Â  Â  Â  Â  // 2. Inicializar cÃ¡lculos e resumo
Â  Â  Â  Â  if (opcoesParcelas.length > 0 && !isNaN(valorCarro)) {
Â  Â  Â  Â  Â  Â  updateAllCalculations();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  totalDisplay.textContent = formatarMoeda(0);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Listeners
Â  Â  Â  Â  installmentsSelect.addEventListener('change', updateSummary);
Â  Â  Â  Â  btnCadastro.addEventListener('click', redirectToCadastro); 
Â  Â  });

Â  Â  </script>

Â  Â  Â  Â  Â  Â  <div class="ai-assistant-container" aria-label="Assistente de InteligÃªncia Artificial Turbo Auto Car">
Â  Â  <div class="ai-icon" id="ai-toggle"></div> 

Â  Â  <div class="ai-chat-window" id="ai-window">
Â  Â  Â  Â  <div class="chat-header">
Â  Â  Â  Â  Â  Â  <h4>Assistente Turbo Auto Car ðŸš—</h4>
Â  Â  Â  Â  Â  Â  <span class="close-btn">&times;</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="chat-body">
Â  Â  Â  Â  Â  Â  <p class="message bot-message">OlÃ¡! Sou seu assistente virtual. Como posso te ajudar hoje?</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="chat-footer">
Â  Â  Â  Â  Â  Â  <input type="text" placeholder="Digite sua mensagem...">
Â  Â  Â  Â  Â  Â  <button>Enviar</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
    </div>
    <script src="./src/ai-script.js"></script>
</body>
</html>